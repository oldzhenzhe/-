<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>兒科預約系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- 登錄/註冊頁面 -->
  <div id="auth-page" class="flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
      <h1 class="text-2xl font-bold text-center mb-6">兒科預約系統</h1>

      <!-- 登錄/註冊切換 -->
      <div id="auth-section" class="mb-6">
        <div class="flex justify-around mb-4">
          <button id="login-tab" class="px-4 py-2 bg-blue-500 text-white rounded">登錄</button>
          <button id="register-tab" class="px-4 py-2 bg-gray-300 text-black rounded">註冊</button>
        </div>

        <!-- 登錄表單 -->
        <div id="login-form">
          <div class="mb-4">
            <label class="block text-sm font-medium">用戶名</label>
            <input type="text" id="login-username" class="w-full p-2 border rounded" placeholder="輸入用戶名">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium">密碼</label>
            <input type="password" id="login-password" class="w-full p-2 border rounded" placeholder="輸入密碼">
          </div>
          <button onclick="handleLogin()" class="w-full bg-blue-500 text-white p-2 rounded">登錄</button>
        </div>

        <!-- 註冊表單 -->
        <div id="register-form" class="hidden">
          <div class="mb-4">
            <label class="block text-sm font-medium">用戶名</label>
            <input type="text" id="register-username" class="w-full p-2 border rounded" placeholder="輸入用戶名">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium">密碼</label>
            <input type="password" id="register-password" class="w-full p-2 border rounded" placeholder="輸入密碼">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium">聯繫電話</label>
            <input type="text" id="register-phone" class="w-full p-2 border rounded" placeholder="輸入電話">
          </div>
          <button onclick="handleRegister()" class="w-full bg-blue-500 text-white p-2 rounded">註冊</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 首頁（登錄後顯示） -->
  <div id="home-page" class="hidden min-h-screen flex">
    <!-- 左側導航欄 -->
    <div class="w-1/5 bg-gray-800 text-white p-4">
      <h2 class="text-lg font-bold mb-4">掛號系統</h2>
      <ul>
        <li class="mb-2">
          <button onclick="showHome()" class="w-full text-left p-2 bg-gray-700 rounded">首頁</button>
        </li>
        <li class="mb-2">
          <button onclick="showAppointment()" class="w-full text-left p-2 bg-gray-700 rounded">預約掛號</button>
        </li>
        <li class="mb-2">
          <button onclick="showRecords()" class="w-full text-left p-2 bg-gray-700 rounded">掛號紀錄</button>
        </li>
        <li class="mb-2">
          <button onclick="showDoctors()" class="w-full text-left p-2 bg-gray-700 rounded">醫師介紹</button>
        </li>
        <li class="mb-2">
          <button onclick="showProfile()" class="w-full text-left p-2 bg-gray-700 rounded">個人介面</button>
        </li>
        <li>
          <button onclick="handleLogout()" class="w-full text-left p-2 bg-red-500 rounded">登出</button>
        </li>
      </ul>
    </div>

    <!-- 右側主內容區域 -->
    <div class="w-4/5 p-8">
      <!-- 首頁內容 -->
      <div id="home-content">
        <h1 class="text-2xl font-bold mb-4">首頁</h1>
        <div class="grid grid-cols-2 gap-4">
          <!-- 醫生班表 -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-lg font-bold mb-2">醫生班表</h2>
            <table class="w-full text-sm">
              <thead>
                <tr>
                  <th class="border p-2">醫師</th>
                  <th class="border p-2">日期</th>
                  <th class="border p-2">時段</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="border p-2">張醫師</td>
                  <td class="border p-2">2025-04-20</td>
                  <td class="border p-2">上午</td>
                </tr>
                <tr>
                  <td class="border p-2">李醫師</td>
                  <td class="border p-2">2025-04-20</td>
                  <td class="border p-2">下午</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 公告 -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-lg font-bold mb-2">公告</h2>
            <ul class="list-disc pl-4">
              <li>2025-04-19：系統維護，預約功能暫停。</li>
              <li>2025-04-18：新增醫師班表查詢功能。</li>
            </ul>
          </div>

          <!-- 診間 -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-lg font-bold mb-2">診間</h2>
            <p>診間 1：張醫師（上午，剩餘名額：<span id="room1-quota">5</span>）</p>
            <p>診間 2：李醫師（下午，剩餘名額：<span id="room2-quota">5</span>）</p>
          </div>

          <!-- 現在叫號 -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-lg font-bold mb-2">現在叫號</h2>
            <div id="current-call">
              <p class="text-2xl font-bold text-green-500">A001</p>
              <p>診間：診間 1</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 預約表單 -->
      <div id="appointment-section" class="hidden">
        <h1 class="text-2xl font-bold mb-4">預約掛號</h1>
        <div class="mb-4">
          <label class="block text-sm font-medium">選擇科別</label>
          <select id="department" class="w-full p-2 border rounded">
            <option value="兒科">兒科</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium">選擇醫師</label>
          <select id="doctor" class="w-full p-2 border rounded">
            <option value="張醫師">張醫師</option>
            <option value="李醫師">李醫師</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium">預約日期</label>
          <input type="date" id="appointment-date" class="w-full p-2 border rounded">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium">預約時段</label>
          <select id="appointment-time" class="w-full p-2 border rounded">
            <option value="上午">上午</option>
            <option value="下午">下午</option>
          </select>
        </div>
        <button onclick="handleAppointment()" class="w-full bg-green-500 text-white p-2 rounded">提交預約</button>
      </div>

      <!-- 掛號紀錄 -->
      <div id="records-section" class="hidden">
        <h1 class="text-2xl font-bold mb-4">掛號紀錄</h1>
        <table id="records-table" class="w-full text-sm border-collapse">
          <thead>
            <tr>
              <th class="border p-2">用戶名</th>
              <th class="border p-2">科別</th>
              <th class="border p-2">醫師</th>
              <th class="border p-2">日期</th>
              <th class="border p-2">時段</th>
              <th class="border p-2">狀態</th>
              <th class="border p-2">操作</th>
            </tr>
          </thead>
          <tbody id="records-body"></tbody>
        </table>
      </div>

      <!-- 醫師介紹 -->
      <div id="doctors-section" class="hidden">
        <h1 class="text-2xl font-bold mb-4">醫師介紹</h1>
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-lg font-bold mb-2">張醫師</h2>
            <p><strong>專長：</strong>小兒內科、過敏與免疫</p>
            <p><strong>簡介：</strong>張醫師擁有10年以上的兒科臨床經驗，專注於小兒過敏性疾病的診斷與治療，深受家長信賴。</p>
          </div>
          <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-lg font-bold mb-2">李醫師</h2>
            <p><strong>專長：</strong>小兒神經科、新生兒照護</p>
            <p><strong>簡介：</strong>李醫師畢業於頂尖醫學院，擅長新生兒重症照護及小兒神經發育問題，耐心細緻，備受好評。</p>
          </div>
        </div>
      </div>

      <!-- 個人介面 -->
      <div id="profile-section" class="hidden">
        <h1 class="text-2xl font-bold mb-4">個人介面</h1>
        <div class="grid grid-cols-2 gap-4">
          <!-- 基本資料 -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-lg font-bold mb-2">基本資料</h2>
            <p><strong>用戶名：</strong><span id="profile-username"></span></p>
            <p><strong>電話：</strong><span id="profile-phone"></span></p>
            <button onclick="editProfile()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded">編輯資料</button>
          </div>

          <!-- 病例 -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-lg font-bold mb-2">病例</h2>
            <div id="medical-records">
              <p>暫無病例記錄。</p>
            </div>
          </div>

          <!-- 預約查詢 -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-lg font-bold mb-2">預約查詢</h2>
            <table id="appointment-query-table" class="w-full text-sm border-collapse">
              <thead>
                <tr>
                  <th class="border p-2">科別</th>
                  <th class="border p-2">醫師</th>
                  <th class="border p-2">日期</th>
                  <th class="border p-2">時段</th>
                  <th class="border p-2">狀態</th>
                </tr>
              </thead>
              <tbody id="appointment-query-body"></tbody>
            </table>
          </div>

          <!-- 設定 -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-lg font-bold mb-2">設定</h2>
            <div class="mb-4">
              <label class="block text-sm font-medium">更改密碼</label>
              <input type="password" id="new-password" class="w-full p-2 border rounded" placeholder="輸入新密碼">
            </div>
            <button onclick="changePassword()" class="px-4 py-2 bg-blue-500 text-white rounded">儲存新密碼</button>
          </div>
        </div>
        <!-- 登出按鈕 -->
        <div class="mt-4">
          <button onclick="handleLogout()" class="w-full bg-red-500 text-white p-2 rounded">登出</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let users = JSON.parse(localStorage.getItem('users')) || [];
    let currentUser = null;
    let appointments = JSON.parse(localStorage.getItem('appointments')) || [];

    // 診間最大預約人數設定
    const MAX_QUOTA_PER_ROOM = 5; // 每間診間最大預約人數
    const rooms = {
      '診間 1': { doctor: '張醫師', time: '上午', currentQuota: 0 },
      '診間 2': { doctor: '李醫師', time: '下午', currentQuota: 0 }
    };

    // 切換登錄/註冊表單
    document.getElementById('login-tab').addEventListener('click', () => {
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('register-form').classList.add('hidden');
      document.getElementById('login-tab').classList.add('bg-blue-500', 'text-white');
      document.getElementById('register-tab').classList.remove('bg-blue-500', 'text-white');
      document.getElementById('register-tab').classList.add('bg-gray-300', 'text-black');
    });

    document.getElementById('register-tab').addEventListener('click', () => {
      document.getElementById('register-form').classList.remove('hidden');
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('register-tab').classList.add('bg-blue-500', 'text-white');
      document.getElementById('login-tab').classList.remove('bg-blue-500', 'text-white');
      document.getElementById('login-tab').classList.add('bg-gray-300', 'text-black');
    });

    // 處理註冊
    function handleRegister() {
      const username = document.getElementById('register-username').value;
      const password = document.getElementById('register-password').value;
      const phone = document.getElementById('register-phone').value;

      if (username && password && phone) {
        if (users.find(user => user.username === username)) {
          alert('用戶名已存在！');
          return;
        }
        users.push({ username, password, phone });
        localStorage.setItem('users', JSON.stringify(users));
        alert('註冊成功！請登錄。');
        document.getElementById('login-tab').click();
      } else {
        alert('請填寫所有欄位！');
      }
    }

    // 處理登錄
    function handleLogin() {
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;

      const user = users.find(user => user.username === username && user.password === password);
      if (user) {
        currentUser = user;
        document.getElementById('auth-page').classList.add('hidden');
        document.getElementById('home-page').classList.remove('hidden');
        initializeQuotas(); // 初始化診間預約人數
        showHome();
      } else {
        alert('用戶名或密碼錯誤！');
      }
    }

    // 初始化診間預約人數
    function initializeQuotas() {
      // 重置診間預約人數
      rooms['診間 1'].currentQuota = 0;
      rooms['診間 2'].currentQuota = 0;

      // 計算現有預約人數
      appointments.forEach(appointment => {
        if (appointment.status === '待審核') {
          let roomKey = null;
          if (appointment.doctor === '張醫師' && appointment.time === '上午') {
            roomKey = '診間 1';
          } else if (appointment.doctor === '李醫師' && appointment.time === '下午') {
            roomKey = '診間 2';
          }
          if (roomKey && rooms[roomKey]) {
            rooms[roomKey].currentQuota++;
          }
        }
      });

      // 更新首頁診間名額顯示
      document.getElementById('room1-quota').textContent = MAX_QUOTA_PER_ROOM - rooms['診間 1'].currentQuota;
      document.getElementById('room2-quota').textContent = MAX_QUOTA_PER_ROOM - rooms['診間 2'].currentQuota;
    }

    // 檢查診間預約人數是否已滿
    function checkRoomQuota(doctor, time) {
      let roomKey = null;
      if (doctor === '張醫師' && time === '上午') {
        roomKey = '診間 1';
      } else if (doctor === '李醫師' && time === '下午') {
        roomKey = '診間 2';
      }

      if (roomKey && rooms[roomKey].currentQuota >= MAX_QUOTA_PER_ROOM) {
        return false; // 診間已滿
      }
      return true;
    }

    // 處理預約
    function handleAppointment() {
      const department = document.getElementById('department').value;
      const doctor = document.getElementById('doctor').value;
      const date = document.getElementById('appointment-date').value;
      const time = document.getElementById('appointment-time').value;

      if (department && doctor && date && time) {
        // 檢查診間預約人數
        if (!checkRoomQuota(doctor, time)) {
          alert('該診間預約人數已滿，請選擇其他醫師或時段！');
          return;
        }

        const appointment = { 
          username: currentUser.username, 
          department, 
          doctor, 
          date, 
          time, 
          status: '待審核',
          callNumber: generateCallNumber()
        };
        appointments.push(appointment);
        localStorage.setItem('appointments', JSON.stringify(appointments));
        alert(`預約成功！\n科別：${department}\n醫師：${doctor}\n日期：${date}\n時段：${time}\n叫號：${appointment.callNumber}`);
        
        // 更新診間預約人數
        initializeQuotas();
        showRecords();
        updateCurrentCall();
      } else {
        alert('請填寫所有欄位！');
      }
    }

    // 生成簡單的叫號（模擬）
    function generateCallNumber() {
      const lastAppointment = appointments[appointments.length - 1];
      if (!lastAppointment || !lastAppointment.callNumber) {
        return 'A001';
      }
      const lastNumber = parseInt(lastAppointment.callNumber.slice(1)) + 1;
      return `A${lastNumber.toString().padStart(3, '0')}`;
    }

    // 更新現在叫號
    function updateCurrentCall() {
      const pendingAppointments = appointments.filter(appointment => appointment.status === '待審核');
      const currentCallDiv = document.getElementById('current-call');
      if (pendingAppointments.length > 0) {
        const current = pendingAppointments[0];
        let room = '診間 1';
        if (current.doctor === '李醫師' && current.time === '下午') {
          room = '診間 2';
        }
        currentCallDiv.innerHTML = `
          <p class="text-2xl font-bold text-green-500">${current.callNumber}</p>
          <p>診間：${room}</p>
        `;
      } else {
        currentCallDiv.innerHTML = `
          <p class="text-2xl font-bold text-green-500">無</p>
          <p>診間：-</p>
        `;
      }
    }

    // 取消預約功能
    function cancelAppointment(index) {
      if (confirm('確定要取消此預約嗎？')) {
        appointments[index].status = '已取消';
        localStorage.setItem('appointments', JSON.stringify(appointments));
        initializeQuotas(); // 更新診間預約人數
        showRecords();
        updateCurrentCall();
        alert('預約已取消！');
      }
    }

    // 處理登出
    function handleLogout() {
      currentUser = null;
      document.getElementById('auth-page').classList.remove('hidden');
      document.getElementById('home-page').classList.add('hidden');
      document.getElementById('login-tab').click();
    }

    // 顯示首頁
    function showHome() {
      document.getElementById('home-content').classList.remove('hidden');
      document.getElementById('appointment-section').classList.add('hidden');
      document.getElementById('records-section').classList.add('hidden');
      document.getElementById('doctors-section').classList.add('hidden');
      document.getElementById('profile-section').classList.add('hidden');
      initializeQuotas();
      updateCurrentCall();
    }

    // 顯示預約表單
    function showAppointment() {
      document.getElementById('home-content').classList.add('hidden');
      document.getElementById('appointment-section').classList.remove('hidden');
      document.getElementById('records-section').classList.add('hidden');
      document.getElementById('doctors-section').classList.add('hidden');
      document.getElementById('profile-section').classList.add('hidden');
    }

    // 顯示掛號紀錄
    function showRecords() {
      document.getElementById('home-content').classList.add('hidden');
      document.getElementById('appointment-section').classList.add('hidden');
      document.getElementById('records-section').classList.remove('hidden');
      document.getElementById('doctors-section').classList.add('hidden');
      document.getElementById('profile-section').classList.add('hidden');

      const recordsBody = document.getElementById('records-body');
      recordsBody.innerHTML = '';

      const userAppointments = appointments.filter(appointment => appointment.username === currentUser.username);
      if (userAppointments.length === 0) {
        recordsBody.innerHTML = '<tr><td colspan="7" class="border p-2 text-center">暫無掛號紀錄。</td></tr>';
      } else {
        userAppointments.forEach((appointment, index) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="border p-2">${appointment.username}</td>
            <td class="border p-2">${appointment.department}</td>
            <td class="border p-2">${appointment.doctor}</td>
            <td class="border p-2">${appointment.date}</td>
            <td class="border p-2">${appointment.time}</td>
            <td class="border p-2">${appointment.status}</td>
            <td class="border p-2">
              ${appointment.status === '待審核' ? `<button onclick="cancelAppointment(${index})" class="px-2 py-1 bg-red-500 text-white rounded">取消</button>` : '-'}
            </td>
          `;
          recordsBody.appendChild(row);
        });
      }
    }

    // 顯示醫師介紹
    function showDoctors() {
      document.getElementById('home-content').classList.add('hidden');
      document.getElementById('appointment-section').classList.add('hidden');
      document.getElementById('records-section').classList.add('hidden');
      document.getElementById('doctors-section').classList.remove('hidden');
      document.getElementById('profile-section').classList.add('hidden');
    }

    // 顯示個人介面
    function showProfile() {
      document.getElementById('home-content').classList.add('hidden');
      document.getElementById('appointment-section').classList.add('hidden');
      document.getElementById('records-section').classList.add('hidden');
      document.getElementById('doctors-section').classList.add('hidden');
      document.getElementById('profile-section').classList.remove('hidden');

      document.getElementById('profile-username').textContent = currentUser.username;
      document.getElementById('profile-phone').textContent = currentUser.phone;

      const appointmentQueryBody = document.getElementById('appointment-query-body');
      appointmentQueryBody.innerHTML = '';

      const userAppointments = appointments.filter(appointment => appointment.username === currentUser.username);
      if (userAppointments.length === 0) {
        appointmentQueryBody.innerHTML = '<tr><td colspan="5" class="border p-2 text-center">暫無預約記錄。</td></tr>';
      } else {
        userAppointments.forEach(appointment => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="border p-2">${appointment.department}</td>
            <td class="border p-2">${appointment.doctor}</td>
            <td class="border p-2">${appointment.date}</td>
            <td class="border p-2">${appointment.time}</td>
            <td class="border p-2">${appointment.status}</td>
          `;
          appointmentQueryBody.appendChild(row);
        });
      }
    }

    // 編輯個人資料
    function editProfile() {
      const newPhone = prompt('請輸入新的電話號碼：', currentUser.phone);
      if (newPhone) {
        const userIndex = users.findIndex(user => user.username === currentUser.username);
        users[userIndex].phone = newPhone;
        currentUser.phone = newPhone;
        localStorage.setItem('users', JSON.stringify(users));
        document.getElementById('profile-phone').textContent = newPhone;
        alert('電話號碼已更新！');
      }
    }

    // 更改密碼
    function changePassword() {
      const newPassword = document.getElementById('new-password').value;
      if (newPassword) {
        const userIndex = users.findIndex(user => user.username === currentUser.username);
        users[userIndex].password = newPassword;
        currentUser.password = newPassword;
        localStorage.setItem('users', JSON.stringify(users));
        document.getElementById('new-password').value = '';
        alert('密碼已更新！請記住您的新密碼。');
      } else {
        alert('請輸入新密碼！');
      }
    }
  </script>
</body>
</html>
